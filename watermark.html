<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‹—è›‹å»æ°´å°</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#4080FF',
            neutral: '#F5F7FA',
            dark: '#1D2129',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style>
    .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
  </style>
</head>
<body class="font-inter bg-gradient-to-b from-neutral to-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur border-b border-gray-100 sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <div class="w-9 h-9 rounded-xl bg-primary/10 flex items-center justify-center">
          <span class="text-primary font-semibold text-lg">ç‹—</span>
        </div>
        <div>
          <div class="text-lg font-semibold text-dark">ç‹—è›‹å»æ°´å°</div>
          <div class="text-xs text-gray-400">ä¸“æ²»å³ä¸‹è§’ã€Œè±†åŒ…AIç”Ÿæˆã€</div>
        </div>
      </div>
      <div class="hidden md:flex items-center space-x-4 text-sm text-gray-500">
        <span class="flex items-center">
          <span class="w-2 h-2 rounded-full bg-emerald-400 mr-1.5"></span>
          æœ¬åœ°å¤„ç† Â· ä¸ä¸Šä¼ æœåŠ¡å™¨
        </span>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full">
    <!-- é¡¶éƒ¨ä»‹ç» -->
    <section class="mb-6">
      <div class="bg-white rounded-2xl card-shadow p-5 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 class="text-xl md:text-2xl font-semibold text-dark mb-2">ä¸€é”®å»æ‰å³ä¸‹è§’æ°´å°</h1>
          <p class="text-gray-500 text-sm md:text-base">
            æ”¯æŒæ‰¹é‡ä¸Šä¼ å›¾ç‰‡ï¼Œä»…å¤„ç†å³ä¸‹è§’ã€Œè±†åŒ…AIç”Ÿæˆã€ç›¸å…³æ–‡æ¡ˆï¼Œè‡ªåŠ¨æŒ‰èƒŒæ™¯è‰²æ™ºèƒ½å¡«å……è¦†ç›–ã€‚
          </p>
          <div class="flex flex-wrap gap-2 mt-3 text-xs">
            <span class="px-2.5 py-1 rounded-full bg-primary/5 text-primary">æœ¬åœ°å¤„ç†</span>
            <span class="px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-600">å›¾ç‰‡ä¸ä¸Šä¼ æœåŠ¡å™¨</span>
            <span class="px-2.5 py-1 rounded-full bg-gray-100 text-gray-600">æ”¯æŒæ‰¹é‡ä¸Šä¼ </span>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-2 text-xs text-gray-500">
          <div class="flex flex-col items-center">
            <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center mb-1 text-primary text-sm">1</div>
            <span>ä¸Šä¼ å›¾ç‰‡</span>
          </div>
          <div class="flex flex-col items-center">
            <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center mb-1 text-primary text-sm">2</div>
            <span>ä¸€é”®å»æ°´å°</span>
          </div>
          <div class="flex flex-col items-center">
            <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center mb-1 text-primary text-sm">3</div>
            <span>ä¸‹è½½å›¾ç‰‡</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ä¸»ä½“åŒºåŸŸï¼šå·¦ä¾§ä¸Šä¼  / å³ä¾§é¢„è§ˆ -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl card-shadow p-6">
          <h2 class="text-base font-semibold text-dark mb-1">ä¸Šä¼ å›¾ç‰‡</h2>
          <p class="text-xs text-gray-500 mb-4">
            æ”¯æŒæ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ ï¼Œå•å¼  â‰¤ 5MBï¼Œå•æ¬¡æœ€å¤š 20 å¼ ã€‚
          </p>

          <div id="drop-area"
               class="border border-dashed border-gray-300 rounded-xl px-4 py-8 text-center transition-all bg-gray-50 hover:bg-gray-100 cursor-pointer">
            <div class="flex flex-col items-center">
              <div class="w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M3 15.75l7.5-7.5 4.5 4.5L21 6.75M4.5 19.5h15"/>
                </svg>
              </div>
              <p class="text-sm text-dark mb-1">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ï¼Œæˆ–</p>
              <button id="upload-btn"
                      class="inline-flex items-center px-4 py-2 rounded-md bg-primary text-white text-sm font-medium hover:bg-primary/90">
                é€‰æ‹©å›¾ç‰‡
              </button>
              <p class="text-xs text-gray-400 mt-2">æ”¯æŒ JPG / JPEG / PNG</p>
            </div>
            <input id="file-input" type="file" multiple accept="image/*" class="hidden">
          </div>

          <div class="mt-4 space-y-1 text-xs text-gray-500">
            <div class="flex items-center justify-between">
              <span>å·²é€‰æ‹©å›¾ç‰‡ï¼š</span>
              <span id="file-count" class="font-medium text-dark">0 å¼ </span>
            </div>
            <div class="border-t border-dashed border-gray-200 pt-3 mt-2">
              <p class="flex items-start">
                <span class="w-1.5 h-1.5 rounded-full bg-primary mr-2 mt-1"></span>
                ä»…è¦†ç›–å³ä¸‹è§’åŒºåŸŸï¼Œä¸ä¿®æ”¹å›¾ç‰‡å…¶ä»–å†…å®¹ã€‚
              </p>
              <p class="flex items-start">
                <span class="w-1.5 h-1.5 rounded-full bg-primary mr-2 mt-1"></span>
                å»æ°´å°è¿‡ç¨‹å®Œå…¨åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆã€‚
              </p>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="bg-white rounded-2xl card-shadow p-4 mt-4">
          <button id="process-btn"
                  class="w-full flex items-center justify-center px-4 py-2.5 rounded-lg bg-secondary text-white text-sm font-medium hover:bg-secondary/90 disabled:opacity-60 disabled:cursor-not-allowed">
            <span id="process-btn-text" class="flex items-center">
              <span class="mr-2">
                ğŸ§¼
              </span>
              ä¸€é”®è¦†ç›–å³ä¸‹è§’æ°´å°
            </span>
          </button>
        </div>
      </div>

      <!-- é¢„è§ˆåŒºåŸŸ -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl card-shadow p-5 h-full flex flex-col">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-base font-semibold text-dark">å›¾ç‰‡é¢„è§ˆä¸ä¸‹è½½</h2>
            <span class="text-xs text-gray-400">å»æ°´å°å®Œæˆåï¼Œå¯å•å¼ ä¸‹è½½å¤„ç†åçš„å›¾ç‰‡</span>
          </div>

          <div id="empty-hint" class="flex-1 flex items-center justify-center text-gray-400 text-sm py-10">
            æš‚æœªä¸Šä¼ å›¾ç‰‡ï¼Œè¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡ã€‚
          </div>

          <div id="preview-container" class="flex-1 hidden">
            <div id="preview-grid"
                 class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
              <!-- åŠ¨æ€æ’å…¥å¡ç‰‡ -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-100 py-4 mt-8">
    <div class="max-w-6xl mx-auto px-4 text-center text-xs text-gray-400">
      Â© 2025 ç‹—è›‹å»æ°´å° Â· æœ¬å·¥å…·ä»…ä½œå­¦ä¹ äº¤æµä½¿ç”¨ï¼Œè¯·å‹¿ç”¨äºè¿è§„ç”¨é€”
    </div>
  </footer>

  <!-- JS -->
  <script>
    const uploadBtn = document.getElementById("upload-btn");
    const fileInput = document.getElementById("file-input");
    const dropArea = document.getElementById("drop-area");
    const previewGrid = document.getElementById("preview-grid");
    const previewContainer = document.getElementById("preview-container");
    const emptyHint = document.getElementById("empty-hint");
    const fileCount = document.getElementById("file-count");
    const processBtn = document.getElementById("process-btn");
    const processBtnText = document.getElementById("process-btn-text");

    const MAX_FILES = 20;
    const MAX_SIZE = 5 * 1024 * 1024; // 5MB

    /* ------------ å·¥å…·å‡½æ•°ï¼šåŠ è½½å›¾ç‰‡ã€å–é¢œè‰²ã€ä¸‹è½½ ------------- */

    function loadImage(src) {
      return new Promise(res => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => res(img);
        img.src = src;
      });
    }

    function getDominantColor(ctx, x, y, w, h) {
      const data = ctx.getImageData(x, y, w, h).data;
      let r = 0, g = 0, b = 0, count = 0;

      for (let i = 0; i < data.length; i += 4) {
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
        count++;
      }
      return `rgb(${Math.round(r/count)}, ${Math.round(g/count)}, ${Math.round(b/count)})`;
    }

    async function coverWatermark(imgSrc) {
      const img = await loadImage(imgSrc);
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = img.width;
      canvas.height = img.height;

      ctx.drawImage(img, 0, 0);

      // å³ä¸‹è§’æ°´å°åŒºåŸŸï¼ˆå¯æŒ‰éœ€è¦å¾®è°ƒæ¯”ä¾‹ï¼‰
      const w = img.width * 0.18;
      const h = img.height * 0.10;
      const x = img.width - w - 10;
      const y = img.height - h - 8;

      // ä»ä¸Šæ–¹åŒºåŸŸå–æ ·é¢œè‰²
      const sampleColor = getDominantColor(
        ctx,
        Math.max(0, x - 30),
        Math.max(0, y - 30),
        Math.min(40, x),
        Math.min(40, y)
      );

      // å…ˆç”¨ä¸»è‰²å—è¦†ç›–
      ctx.fillStyle = sampleColor;
      ctx.fillRect(x, y, w, h);

      // å†è½»åº¦æ¨¡ç³Šå¹³æ»‘è¾¹ç¼˜
      ctx.globalAlpha = 0.45;
      ctx.filter = "blur(10px)";
      ctx.drawImage(canvas, x-8, y-8, w+16, h+16, x, y, w, h);

      ctx.globalAlpha = 1;
      ctx.filter = "none";

      return canvas.toDataURL("image/png");
    }

    function readFileAsURL(file) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }

    function safeFilename(name) {
      return (name || "image")
        .replace(/\.[^.]+$/, "")
        .replace(/[^\w\u4e00-\u9fa5-]+/g, "_") + "_clean.png";
    }

    function downloadImage(dataUrl, filename) {
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    /* ------------ ç”Ÿæˆé¢„è§ˆå¡ç‰‡ ------------- */

    function createPreviewItem(src, filename) {
      const item = document.createElement("div");
      item.className = "relative bg-gray-50 rounded-xl border border-gray-100 p-3 flex flex-col";
      item.dataset.filename = filename || "image.png";
      item.dataset.processed = "false";

      item.innerHTML = `
        <div class="relative mb-2">
          <div class="aspect-video w-full bg-white rounded-lg flex items-center justify-center overflow-hidden">
            <img src="${src}" class="max-h-56 w-full object-contain bg-white" />
          </div>
          <button class="absolute top-2 right-2 text-xs px-2 py-1 rounded-full bg-white/90 hover:bg-white text-gray-500 hover:text-red-500 shadow-sm">
            åˆ é™¤
          </button>
        </div>
        <div class="flex-1 flex flex-col justify-between">
          <div class="mb-2">
            <div class="text-xs font-medium text-dark truncate" title="${filename || "æœªå‘½åå›¾ç‰‡"}">
              ${filename || "æœªå‘½åå›¾ç‰‡"}
            </div>
            <div class="mt-1">
              <span class="inline-flex items-center text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 status-badge">
                å¾…å¤„ç†
              </span>
            </div>
          </div>
          <div class="flex items-center justify-between mt-1">
            <button class="text-xs px-2.5 py-1 rounded-md bg-gray-100 text-gray-600 hover:bg-gray-200 download-btn opacity-40 cursor-not-allowed">
              ä¸‹è½½å»æ°´å°å›¾
            </button>
          </div>
        </div>
      `;

      const img = item.querySelector("img");
      const deleteBtn = item.querySelector("button");
      const downloadBtn = item.querySelector(".download-btn");

      deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        item.remove();
        updateStateAfterChange();
      });

      downloadBtn.addEventListener("click", () => {
        if (item.dataset.processed !== "true") {
          alert("è¯·å…ˆç‚¹å‡»å·¦ä¾§æŒ‰é’®å®Œæˆå»æ°´å°ï¼Œå†ä¸‹è½½å›¾ç‰‡ã€‚");
          return;
        }
        downloadImage(img.src, safeFilename(item.dataset.filename));
      });

      return item;
    }

    function updateStateAfterChange() {
      const count = previewGrid.children.length;
      fileCount.textContent = `${count} å¼ `;
      if (count === 0) {
        previewContainer.classList.add("hidden");
        emptyHint.classList.remove("hidden");
      }
    }

    async function handleFiles(files) {
      const currentCount = previewGrid.children.length;
      const rest = MAX_FILES - currentCount;
      if (rest <= 0) {
        alert(`å•æ¬¡æœ€å¤šæ”¯æŒ ${MAX_FILES} å¼ å›¾ç‰‡ã€‚`);
        return;
      }

      const arr = Array.from(files).slice(0, rest);
      const oversize = arr.filter(f => f.size > MAX_SIZE);
      if (oversize.length) {
        alert("å­˜åœ¨è¶…è¿‡ 5MB çš„å›¾ç‰‡ï¼Œå·²è‡ªåŠ¨å¿½ç•¥å¤§æ–‡ä»¶ã€‚");
      }

      for (const file of arr) {
        if (file.size > MAX_SIZE) continue;
        const src = await readFileAsURL(file);
        const card = createPreviewItem(src, file.name);
        previewGrid.appendChild(card);
      }

      const count = previewGrid.children.length;
      fileCount.textContent = `${count} å¼ `;
      if (count > 0) {
        previewContainer.classList.remove("hidden");
        emptyHint.classList.add("hidden");
      }
    }

    /* ------------ ä¸Šä¼ äº¤äº’ ------------- */

    uploadBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => handleFiles(fileInput.files));

    ["dragenter", "dragover"].forEach(evt =>
      dropArea.addEventListener(evt, e => {
        e.preventDefault();
        dropArea.classList.add("bg-white", "border-primary");
      })
    );

    ["dragleave", "drop"].forEach(evt =>
      dropArea.addEventListener(evt, e => {
        e.preventDefault();
        dropArea.classList.remove("bg-white", "border-primary");
      })
    );

    dropArea.addEventListener("drop", e => {
      handleFiles(e.dataTransfer.files);
    });

    dropArea.addEventListener("click", () => fileInput.click());

    /* ------------ å»æ°´å°å¤„ç† ------------- */

    processBtn.addEventListener("click", async () => {
      const cards = Array.from(previewGrid.children);
      if (cards.length === 0) {
        alert("è¯·å…ˆä¸Šä¼ éœ€è¦å¤„ç†çš„å›¾ç‰‡ã€‚");
        return;
      }

      processBtn.disabled = true;
      processBtnText.textContent = "å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...";

      for (const card of cards) {
        const img = card.querySelector("img");
        const badge = card.querySelector(".status-badge");
        const downloadBtn = card.querySelector(".download-btn");

        if (card.dataset.processed === "true") continue;

        badge.textContent = "å¤„ç†ä¸­...";
        badge.className = "inline-flex items-center text-[11px] px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 status-badge";

        try {
          const newSrc = await coverWatermark(img.src);
          img.src = newSrc;
          card.dataset.processed = "true";

          badge.textContent = "å·²å»æ°´å°";
          badge.className = "inline-flex items-center text-[11px] px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 status-badge";

          downloadBtn.classList.remove("opacity-40", "cursor-not-allowed");
          downloadBtn.classList.add("bg-primary/10", "text-primary", "hover:bg-primary/15");
        } catch (e) {
          console.error(e);
          badge.textContent = "å¤„ç†å¤±è´¥";
          badge.className = "inline-flex items-center text-[11px] px-2 py-0.5 rounded-full bg-red-50 text-red-600 status-badge";
        }
      }

      processBtn.disabled = false;
      processBtnText.textContent = "ä¸€é”®è¦†ç›–å³ä¸‹è§’æ°´å°";
    });
  </script>
</body>
</html>
