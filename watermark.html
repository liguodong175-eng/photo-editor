<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>狗蛋去水印 · 增强修复 + 一键下载</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<style>
.card-shadow{box-shadow:0 4px 20px rgba(0,0,0,.08)}
</style>
</head>

<body class="bg-gray-100">

<header class="bg-white border-b py-4 mb-4 text-center text-lg font-semibold">
狗蛋去水印 · 智能背景修复增强版
</header>

<main class="max-w-6xl mx-auto px-4 pb-12">

<section class="bg-white rounded-xl card-shadow p-5 mb-5 text-sm leading-relaxed space-y-1">
<div>✅ 本地纯前端处理 · 不裁剪、不拉伸、不压缩</div>
<div>✅ 多行复制 + 渐变融合 + 边缘柔化修复</div>
<div>✅ 批量去水印 + 一键批量下载</div>
</section>

<section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

<!-- Upload -->
<div class="bg-white rounded-xl p-5 card-shadow">
<h2 class="font-semibold mb-2">上传图片</h2>

<div id="drop-area"
class="border border-dashed border-gray-300 rounded-lg py-10 text-center cursor-pointer hover:bg-gray-50">

<p class="mb-2">拖拽或点击上传</p>

<button class="bg-blue-600 text-white px-5 py-2 rounded" id="upload-btn">
选择图片
</button>

<input id="file-input" type="file" multiple accept="image/*" hidden>
<p class="text-xs mt-2 text-gray-400">(单张≤5MB，最多20张)</p>
</div>

<p class="mt-3 text-sm">已选择：
<span id="file-count" class="font-semibold">0</span> 张</p>

<button id="process-btn"
class="w-full mt-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
一键去水印
</button>

<button id="download-all-btn"
class="w-full mt-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded">
⬇ 一键下载全部
</button>
</div>

<!-- Preview -->
<div class="bg-white rounded-xl p-5 card-shadow col-span-2 flex flex-col">
<h2 class="font-semibold mb-3">图片预览</h2>

<div id="empty-hint" class="flex-1 flex items-center justify-center text-gray-400">
暂无图片
</div>

<div id="preview-container"
class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

</div>

</section>

</main>

<footer class="bg-white border-t py-3 text-center text-sm text-gray-400">
© 2025 狗蛋去水印 · 支持批处理下载
</footer>

<script>

const uploadBtn=document.getElementById('upload-btn');
const fileInput=document.getElementById('file-input');
const dropArea=document.getElementById('drop-area');
const preview=document.getElementById('preview-container');
const hint=document.getElementById('empty-hint');
const countEl=document.getElementById('file-count');

const processBtn=document.getElementById('process-btn');
const downloadAllBtn=document.getElementById('download-all-btn');

const MAX_FILES=20;

// ------------ 工具 --------------

function readFile(f){
    return new Promise(res=>{
        let r=new FileReader;
        r.onload=e=>res(e.target.result);
        r.readAsDataURL(f);
    })
}

function loadImage(src){
    return new Promise(res=>{
        let i=new Image();
        i.crossOrigin="anonymous";
        i.onload=()=>res(i);
        i.src=src;
    })
}

function download(src,name){
    let a=document.createElement('a');
    a.href=src;
    a.download=name;
    a.click();
}

// ------------ 水印增强算法 ------------

async function enhancedRemove(src){

    const img=await loadImage(src);
    const c=document.createElement('canvas');
    const ctx=c.getContext('2d');

    c.width=img.width;
    c.height=img.height;

    ctx.drawImage(img,0,0);

    const w = img.width*0.18;
    const h = img.height*0.1;
    const x = img.width - w - 10;
    const y = img.height - h - 8;

    // 多行复制 + 渐变
    for(let row=0;row<h;row++){
        let sy=Math.max(0,y-row-2);
        let line=ctx.getImageData(x,sy,w,1);

        ctx.globalAlpha = row/h * .9 + .1;
        ctx.putImageData(line,x,y+row);
    }

    // 柔化边缘
    ctx.globalAlpha=.35;
    ctx.filter='blur(6px)';
    ctx.drawImage(c,x,y,w,h,x,y,w,h);

    ctx.globalAlpha=1;
    ctx.filter='none';

    return c.toDataURL("image/png");
}

// ------------ UI --------------

function card(src,name){
    const d=document.createElement("div");
    d.className="bg-gray-50 rounded-xl border p-3";
    d.dataset.name=name;
    d.dataset.done="false";

    d.innerHTML=`
    <img src="${src}" class="h-48 mx-auto object-contain bg-white rounded mb-2">
    <div class="text-xs truncate mb-2">${name}</div>
    <div class="status text-xs bg-gray-200 rounded px-2 py-1 inline-block">待处理</div>
    <button class="dl mt-2 w-full text-xs bg-blue-100 py-1 rounded opacity-40 cursor-not-allowed">下载</button>
    `;
    return d;
}

async function upload(files){
    let arr=[...files].slice(0,MAX_FILES-preview.children.length);

    for(let f of arr){
        preview.appendChild(card(await readFile(f),f.name));
    }

    state();
}

function state(){
    let n=preview.children.length;
    countEl.textContent=n;
    hint.classList.toggle("hidden",n>0);
    preview.classList.toggle("hidden",n===0);
}

// ------------ Events ------------

uploadBtn.onclick=()=>fileInput.click();
fileInput.onchange=()=>upload(fileInput.files);

dropArea.onclick=()=>fileInput.click();
dropArea.ondragover=e=>e.preventDefault();
dropArea.ondrop=e=>{
    e.preventDefault();
    upload(e.dataTransfer.files);
};

processBtn.onclick=async()=>{
    let items=[...preview.children];
    if(!items.length){ alert("请先上传图片"); return;}

    processBtn.disabled=true;
    processBtn.textContent="处理中...";

    for(let i of items){
        if(i.dataset.done==="true") continue;

        const img=i.querySelector("img");
        const st=i.querySelector(".status");
        const dl=i.querySelector(".dl");

        st.textContent="处理中...";
        st.className="status bg-yellow-100 px-2 py-1 text-xs rounded inline-block";

        img.src = await enhancedRemove(img.src);

        i.dataset.done="true";
        st.textContent="已完成";
        st.className="status bg-green-100 px-2 py-1 text-xs rounded inline-block";

        dl.classList.remove("opacity-40","cursor-not-allowed");
        dl.textContent="下载";
        dl.onclick=()=>download(img.src,`clean_${Date.now()}.png`);
    }

    processBtn.disabled=false;
    processBtn.textContent="一键去水印";
};

downloadAllBtn.onclick= async ()=>{
    let items=[...preview.children];

    if(!items.length){ alert("还未上传图片"); return;}

    await processBtn.onclick();

    items.forEach((i,idx)=>{
        let img=i.querySelector("img");
        download(img.src,`clean_${String(idx+1).padStart(3,"0")}.png`);
    });
}

</script>
</body>
</html>
