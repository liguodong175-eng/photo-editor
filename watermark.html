<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>狗蛋去水印 · 增强修复版</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<style>
.card-shadow{box-shadow:0 4px 20px rgba(0,0,0,.08)}
</style>
</head>

<body class="bg-gray-100">

<header class="bg-white border-b py-4 mb-4 text-center text-lg font-semibold">
狗蛋去水印 · 智能背景修复增强版
</header>

<main class="max-w-6xl mx-auto px-4 pb-12">

<section class="bg-white rounded-xl card-shadow p-6 mb-5 text-sm">
✅ 本地纯前端处理 · ✅ 支持批量上传  
✅ 不裁剪、不压缩、不拉伸  
✅ 按行复制 + 梯度融合 + 边缘柔化
</section>

<section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

<!-- Upload -->
<div class="bg-white rounded-xl p-5 card-shadow">
<h2 class="font-semibold mb-2">上传图片</h2>
<div id="drop-area"
class="border border-dashed border-gray-300 rounded-lg py-10 text-center cursor-pointer hover:bg-gray-50">

<p class="mb-2">拖拽或点击上传</p>

<button class="bg-blue-600 text-white px-5 py-2 rounded" id="upload-btn">
选择图片
</button>

<input id="file-input" type="file" multiple accept="image/*" hidden>
<p class="text-xs mt-2 text-gray-400">(单张≤5MB，最多20张)</p>
</div>

<p class="mt-3 text-sm">已选择：
<span id="file-count" class="font-semibold">0</span> 张</p>

<button id="process-btn"
class="w-full mt-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
一键去水印
</button>
</div>

<!-- Preview -->
<div class="bg-white rounded-xl p-5 card-shadow col-span-2 flex flex-col">
<h2 class="font-semibold mb-3">图片预览 / 下载</h2>

<div id="empty-hint" class="flex-1 flex items-center justify-center text-gray-400">
暂无图片
</div>

<div id="preview-container" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">

</div>
</div>

</section>

</main>

<footer class="bg-white border-t py-3 text-center text-sm text-gray-400">
© 2025 狗蛋去水印·增强修复算法
</footer>

<!-- JS -->
<script>

const uploadBtn = document.getElementById('upload-btn');
const fileInput = document.getElementById('file-input');
const dropArea = document.getElementById('drop-area');
const previewGrid = document.getElementById('preview-container');
const hint = document.getElementById('empty-hint');
const fileCount = document.getElementById('file-count');
const processBtn = document.getElementById('process-btn');

const MAX_FILES = 20;


/* ---------------- 工具 ---------------- */

function readFile(file){
    return new Promise(res=>{
        const r = new FileReader();
        r.onload=e=>res(e.target.result);
        r.readAsDataURL(file);
    });
}

function loadImage(src){
    return new Promise(res=>{
        const img=new Image();
        img.crossOrigin="anonymous";
        img.onload=()=>res(img);
        img.src=src;
    });
}

function download(data,name){
    const a=document.createElement('a');
    a.href=data;
    a.download=name;
    a.click();
}

/* ---------------- 水印增强修复算法 ---------------- */

async function enhancedRemoveWatermark(src){

    const img=await loadImage(src);
    const c=document.createElement("canvas");
    const ctx=c.getContext("2d");

    c.width=img.width;
    c.height=img.height;

    ctx.drawImage(img,0,0);

    // 水印区域
    const w=img.width*0.18;
    const h=img.height*0.1;

    const x=img.width-w-10;
    const y=img.height-h-10;

    // 连续多行复制
    for(let row=0; row<h; row++){

        let srcY=y-row-2;
        if(srcY<0) srcY=0;

        const data=ctx.getImageData(x,srcY,w,1);

        const alpha = row/h;          // 渐变系数
        ctx.globalAlpha=alpha*0.9+0.1;

        ctx.putImageData(data,x,y+row);

    }

    ctx.globalAlpha=1;

    // 柔化边缘
    ctx.globalAlpha=.35;
    ctx.filter="blur(6px)";
    ctx.drawImage(c,x,y,w,h,x,y,w,h);

    ctx.globalAlpha=1;
    ctx.filter="none";

    return c.toDataURL("image/png");
}


/* ---------------- UI ---------------- */

function createItem(src,name){

    const d=document.createElement("div");
    d.className="bg-gray-50 rounded-xl border p-3";

    d.innerHTML=`
        <div class="relative mb-2">
            <img src="${src}" class="max-h-56 w-full object-contain bg-white rounded">
            <button class="absolute top-2 right-2 bg-white/90 px-2 py-1 text-xs rounded shadow delete-btn">删除</button>
        </div>

        <p class="text-xs truncate mb-2">${name}</p>

        <span class="status text-xs bg-gray-200 rounded px-2 py-1">待处理</span>

        <button class="download-btn mt-2 w-full text-xs bg-blue-100 text-blue-600 py-1 rounded cursor-not-allowed opacity-40">下载去水印图</button>
    `;

    const del=d.querySelector('.delete-btn');
    del.onclick=()=>{
        d.remove();
        updateState();
    };

    return d;
}

async function upload(files){

    const arr=[...files].slice(0,MAX_FILES-previewGrid.children.length);

    for(const f of arr){
        const src=await readFile(f);
        previewGrid.appendChild(createItem(src,f.name));
    }

    updateState();
}

function updateState(){
    const cnt=previewGrid.children.length;
    fileCount.textContent = cnt;

    hint.classList.toggle("hidden", cnt>0);
    previewGrid.classList.toggle("hidden", cnt===0);
}

/* ---------------- 事件 ---------------- */

uploadBtn.onclick=()=>fileInput.click();
fileInput.onchange=()=>upload(fileInput.files);

dropArea.onclick=()=>fileInput.click();
dropArea.ondragover = e=>{
    e.preventDefault();
};
dropArea.ondrop = e=>{
    e.preventDefault();
    upload(e.dataTransfer.files);
};


processBtn.onclick=async()=>{

    const cards=[...previewGrid.children];

    if(!cards.length){
        alert("请先上传图片");
        return;
    }

    processBtn.disabled=true;
    processBtn.textContent="处理中...";

    for(const card of cards){

        const img=card.querySelector('img');
        const status=card.querySelector('.status');
        const btn=card.querySelector('.download-btn');

        status.textContent="处理中...";
        status.className="status text-xs bg-yellow-100 px-2 py-1 rounded";

        const newSrc=await enhancedRemoveWatermark(img.src);

        img.src=newSrc;

        status.textContent="已去水印";
        status.className="status text-xs bg-green-100 px-2 py-1 rounded";

        btn.classList.remove("opacity-40","cursor-not-allowed");
        btn.classList.add("bg-green-500","text-white");
        btn.textContent="下载图片";

        btn.onclick=()=>download(newSrc,"clean_"+Date.now()+".png");

    }

    processBtn.disabled=false;
    processBtn.textContent="一键去水印";
};

</script>

</body>
</html>
