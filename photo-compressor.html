<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高效照片压缩+清晰化工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        neutral: '#64748B',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .scale-hover {
                @apply hover:scale-105 transition-all duration-300;
            }
            .func-card-active {
                @apply border-primary bg-blue-50;
            }
            /* 强制显示类，优先级最高 */
            .force-show {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm py-4 px-6 md:px-12">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-compress text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                    照片压缩+清晰化工具
                </h1>
            </div>
            <div class="text-sm text-neutral hidden md:block">
                浏览器端处理 · 保护隐私 · 多功能可选
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="flex-grow container mx-auto p-4 md:p-8 lg:p-12">
        <!-- 功能选择区（固定顶部，不隐藏） -->
        <section id="function-selection" class="mb-10">
            <div class="bg-white rounded-xl shadow-soft p-6 md:p-8">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fa fa-th-large text-primary mr-2"></i>选择处理功能
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 单独压缩入口 -->
                    <div class="func-card border-2 border-gray-200 rounded-xl p-6 transition-custom scale-hover cursor-pointer hover:border-primary" onclick="selectFunc('compress-only', '单独压缩')">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center mb-4">
                                <i class="fa fa-compress text-2xl text-primary"></i>
                            </div>
                            <h3 class="text-lg font-medium mb-2">单独压缩</h3>
                            <p class="text-sm text-neutral">仅减小图片文件大小，保持画质尽量清晰</p>
                        </div>
                    </div>
                    
                    <!-- 单独清晰化入口 -->
                    <div class="func-card border-2 border-gray-200 rounded-xl p-6 transition-custom scale-hover cursor-pointer hover:border-primary" onclick="selectFunc('sharpen-only', '单独清晰化')">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mb-4">
                                <i class="fa fa-eye text-2xl text-secondary"></i>
                            </div>
                            <h3 class="text-lg font-medium mb-2">单独清晰化</h3>
                            <p class="text-sm text-neutral">修复模糊图片，增强边缘细节，不改变文件大小</p>
                        </div>
                    </div>
                    
                    <!-- 综合处理入口 -->
                    <div class="func-card border-2 border-gray-200 rounded-xl p-6 transition-custom scale-hover cursor-pointer hover:border-primary" onclick="selectFunc('both', '综合处理（推荐）')">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-16 h-16 rounded-full bg-purple-100 flex items-center justify-center mb-4">
                                <i class="fa fa-cogs text-2xl text-purple-600"></i>
                            </div>
                            <h3 class="text-lg font-medium mb-2">综合处理（推荐）</h3>
                            <p class="text-sm text-neutral">清晰化+压缩一步完成，兼顾画质和文件大小</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 上传区域（默认隐藏，添加force-show类强制显示） -->
        <section id="upload-section" class="mb-10 force-show">
            <div class="bg-white rounded-xl shadow-soft p-6 md:p-8">
                <h2 id="upload-title" class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fa fa-cloud-upload text-primary mr-2"></i>上传图片（请先选择功能）
                </h2>
                
                <div id="upload-container" class="border-2 border-dashed border-gray-200 hover:border-primary transition-custom p-6 md:p-8 rounded-xl">
                    <div class="flex flex-col items-center justify-center text-center">
                        <i class="fa fa-cloud-upload text-5xl text-primary mb-4"></i>
                        <p id="upload-desc" class="text-neutral mb-6 max-w-md">支持JPG、PNG等格式，文件将在浏览器中处理，不会上传到服务器</p>
                        
                        <label for="file-upload" class="bg-primary hover:bg-primary/90 text-white font-medium py-3 px-8 rounded-lg cursor-pointer transition-custom scale-hover flex items-center">
                            <i class="fa fa-file-image-o mr-2"></i>选择图片
                        </label>
                        <input id="file-upload" type="file" accept="image/*" class="hidden">
                        
                        <p id="file-name" class="mt-4 text-sm text-neutral hidden"></p>
                        <div class="mt-4 flex space-x-4">
                            <button id="reset-upload" class="text-neutral hover:text-red-500 transition-custom hidden" onclick="resetUploadedFile()">
                                <i class="fa fa-times-circle mr-1"></i> 重新选择
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 处理设置区域（上传图片后显示，与功能绑定） -->
        <section id="processing-settings" class="mb-10 hidden">
            <div class="bg-white rounded-xl shadow-soft p-6 md:p-8">
                <h2 id="settings-title" class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fa fa-sliders text-primary mr-2"></i>处理设置
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- 压缩质量设置（单独压缩/综合处理显示） -->
                    <div id="quality-setting" class="hidden">
                        <label for="quality" class="block text-sm font-medium text-gray-700 mb-2">
                            压缩质量: <span id="quality-value">80</span>%
                        </label>
                        <input type="range" id="quality" min="1" max="100" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary" oninput="document.getElementById('quality-value').textContent = this.value">
                        <p class="text-xs text-neutral mt-1">数值越低，压缩率越高，画质可能下降越明显</p>
                    </div>
                    
                    <!-- 输出格式（所有功能都显示） -->
                    <div id="format-setting" class="hidden">
                        <label for="output-format" class="block text-sm font-medium text-gray-700 mb-2">
                            输出格式
                        </label>
                        <select id="output-format" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom">
                            <option value="jpeg">JPEG</option>
                            <option value="png">PNG</option>
                            <option value="webp">WebP (现代格式)</option>
                        </select>
                        <p class="text-xs text-neutral mt-1">选择处理后的图片格式</p>
                    </div>

                    <!-- 清晰化强度设置（单独清晰化/综合处理显示） -->
                    <div id="sharpen-setting" class="hidden">
                        <label for="sharpen-intensity" class="block text-sm font-medium text-gray-700 mb-2">
                            清晰化强度: <span id="sharpen-value">30</span>%
                        </label>
                        <input type="range" id="sharpen-intensity" min="0" max="100" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-secondary" oninput="document.getElementById('sharpen-value').textContent = this.value">
                        <p class="text-xs text-neutral mt-1">数值越高，锐化效果越强（0%=不清晰化，建议30-60%）</p>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-center space-x-4">
                    <button id="back-to-upload" class="border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium py-3 px-8 rounded-lg transition-custom scale-hover flex items-center" onclick="backToUploadStep()">
                        <i class="fa fa-arrow-left mr-2"></i>重新上传
                    </button>
                    <button id="process-btn" class="bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-8 rounded-lg transition-custom scale-hover flex items-center" onclick="processImage()">
                        <i class="fa fa-cog mr-2"></i>开始处理
                    </button>
                </div>
            </div>
        </section>

        <!-- 预览区域 -->
        <section id="preview-section" class="mb-10 hidden">
            <div class="bg-white rounded-xl shadow-soft p-6 md:p-8">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fa fa-eye text-primary mr-2"></i>处理结果对比
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- 原图预览 -->
                    <div class="flex flex-col items-center">
                        <h3 class="text-lg font-medium mb-4">原图</h3>
                        <div class="relative w-full max-w-md h-64 md:h-80 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden mb-4">
                            <img id="original-image" src="" alt="原始图片预览" class="max-w-full max-h-full object-contain hidden">
                            <div id="original-placeholder" class="text-center p-4">
                                <i class="fa fa-image text-4xl text-gray-300 mb-2"></i>
                                <p class="text-gray-400">暂无图片</p>
                            </div>
                        </div>
                        <div class="text-sm text-neutral w-full max-w-md">
                            <p><span class="font-medium">尺寸:</span> <span id="original-dimensions">--</span></p>
                            <p><span class="font-medium">大小:</span> <span id="original-size">--</span></p>
                            <p><span class="font-medium">格式:</span> <span id="original-format">--</span></p>
                        </div>
                    </div>
                    
                    <!-- 处理后预览 -->
                    <div class="flex flex-col items-center">
                        <h3 class="text-lg font-medium mb-4">处理后</h3>
                        <div class="relative w-full max-w-md h-64 md:h-80 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden mb-4">
                            <img id="processed-image" src="" alt="处理后图片预览" class="max-w-full max-h-full object-contain hidden">
                            <div id="processed-placeholder" class="text-center p-4">
                                <i class="fa fa-image text-4xl text-gray-300 mb-2"></i>
                                <p class="text-gray-400">暂无处理结果</p>
                            </div>
                        </div>
                        <div class="text-sm text-neutral w-full max-w-md">
                            <p><span class="font-medium">尺寸:</span> <span id="processed-dimensions">--</span></p>
                            <p><span class="font-medium">大小:</span> <span id="processed-size">--</span></p>
                            <p><span class="font-medium">格式:</span> <span id="processed-format">--</span></p>
                            <p><span class="font-medium">优化:</span> <span id="optimization-info">--</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-center space-x-4">
                    <button id="reprocess-btn" class="border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium py-3 px-8 rounded-lg transition-custom scale-hover flex items-center" onclick="reprocessImage()">
                        <i class="fa fa-refresh mr-2"></i>重新处理
                    </button>
                    <button id="download-btn" class="bg-primary hover:bg-primary/90 text-white font-medium py-3 px-8 rounded-lg transition-custom scale-hover flex items-center disabled:opacity-50 disabled:cursor-not-allowed" disabled="">
                        <i class="fa fa-download mr-2"></i>下载处理后图片
                    </button>
                </div>
            </div>
        </section>
        
        <!-- 提示信息区域 -->
        <section id="info-section" class="bg-blue-50 border-l-4 border-primary p-4 rounded-r-lg mb-10 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-info-circle text-primary"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700" id="info-message">
                        提示信息将显示在这里
                    </p>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-6 px-6">
        <div class="container mx-auto text-center text-sm text-neutral">
            <p>照片压缩+清晰化工具 © 2025 - 所有图片均在您的浏览器中处理，不会上传到任何服务器</p>
        </div>
    </footer>

    <!-- 加载动画 -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mr-4"></div>
            <p class="font-medium">正在处理图片...</p>
        </div>
    </div>

    <script>
        // 全局变量
        let originalImageData = null;
        let processedImageData = null;
        let isImageUploaded = false;
        let selectedFunc = null;
        let selectedFuncName = '';
        
        // 页面加载完成后，强制显示上传区域（双重保险）
        window.onload = function() {
            const uploadSection = document.getElementById('upload-section');
            uploadSection.classList.remove('hidden');
            uploadSection.classList.add('force-show');
            console.log('页面加载完成，上传区域已强制显示');
        };
        
        // 选择功能（直接用onclick绑定，避免事件委托问题）
        function selectFunc(funcType, funcName) {
            selectedFunc = funcType;
            selectedFuncName = funcName;
            
            // 1. 更新功能卡片激活态
            document.querySelectorAll('.func-card').forEach(card => {
                card.classList.remove('func-card-active');
            });
            // 给当前点击的卡片添加激活态（通过onclick传参，直接定位）
            event.currentTarget.classList.add('func-card-active');
            
            // 2. 强制显示上传区域（三重保险）
            const uploadSection = document.getElementById('upload-section');
            uploadSection.classList.remove('hidden');
            uploadSection.classList.add('force-show');
            uploadSection.style.display = 'block';
            uploadSection.style.visibility = 'visible';
            uploadSection.style.opacity = '1';
            
            // 3. 更新上传区域内容
            document.getElementById('upload-title').innerHTML = `<i class="fa fa-cloud-upload text-primary mr-2"></i>上传图片（当前功能：${funcName}）`;
            
            // 更新描述
            const uploadDesc = document.getElementById('upload-desc');
            switch(funcType) {
                case 'compress-only':
                    uploadDesc.textContent = '支持JPG、PNG等格式，仅减小文件大小（保持画质尽量清晰），文件将在浏览器中处理，不会上传到服务器';
                    break;
                case 'sharpen-only':
                    uploadDesc.textContent = '支持JPG、PNG等格式，仅增强图片清晰度（不改变文件大小），文件将在浏览器中处理，不会上传到服务器';
                    break;
                case 'both':
                    uploadDesc.textContent = '支持JPG、PNG等格式，先清晰化再压缩（兼顾画质和文件大小），文件将在浏览器中处理，不会上传到服务器';
                    break;
            }
            
            // 4. 显示提示信息
            showInfo(`已选择「${funcName}」功能，请上传需要处理的图片`, 'info');
            console.log(`选中功能：${funcType}，上传区域已显示`);
        }
        
        // 处理文件上传（直接绑定到input的change事件）
        document.getElementById('file-upload').addEventListener('change', function(e) {
            if (!selectedFunc) {
                showInfo('请先选择处理功能再上传图片', 'warning');
                return;
            }
            
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showInfo('请上传有效的图片文件', 'error');
                resetUploadedFile();
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Data = event.target.result;
                const img = new Image();
                img.onload = function() {
                    originalImageData = {
                        base64: base64Data,
                        width: img.width,
                        height: img.height,
                        size: file.size,
                        format: file.type.split('/')[1]
                    };
                    
                    // 更新原图预览
                    const originalImage = document.getElementById('original-image');
                    const originalPlaceholder = document.getElementById('original-placeholder');
                    originalImage.src = base64Data;
                    originalImage.classList.remove('hidden');
                    originalPlaceholder.classList.add('hidden');
                    document.getElementById('original-dimensions').textContent = `${img.width} × ${img.height} 像素`;
                    document.getElementById('original-size').textContent = formatFileSize(file.size);
                    document.getElementById('original-format').textContent = file.type.split('/')[1].toUpperCase();
                    
                    // 更新上传区域UI
                    document.getElementById('file-name').textContent = file.name;
                    document.getElementById('file-name').classList.remove('hidden');
                    document.getElementById('reset-upload').classList.remove('hidden');
                    document.getElementById('upload-container').classList.remove('border-dashed', 'border-gray-200');
                    document.getElementById('upload-container').classList.add('border-primary');
                    
                    isImageUploaded = true;
                    
                    // 显示设置面板
                    showFunctionSettings();
                    document.getElementById('upload-section').classList.add('hidden');
                    document.getElementById('processing-settings').classList.remove('hidden');
                    
                    showInfo(`图片上传成功，已进入「${selectedFuncName}」设置面板`, 'info');
                };
                img.src = base64Data;
            };
            reader.readAsDataURL(file);
        });
        
        // 显示功能对应的设置项
        function showFunctionSettings() {
            // 隐藏所有设置项
            document.getElementById('quality-setting').classList.add('hidden');
            document.getElementById('format-setting').classList.add('hidden');
            document.getElementById('sharpen-setting').classList.add('hidden');
            
            // 更新设置标题
            document.getElementById('settings-title').innerHTML = `<i class="fa fa-sliders text-primary mr-2"></i>${selectedFuncName}设置`;
            
            // 根据功能显示设置项
            switch(selectedFunc) {
                case 'compress-only':
                    document.getElementById('quality-setting').classList.remove('hidden');
                    document.getElementById('format-setting').classList.remove('hidden');
                    break;
                case 'sharpen-only':
                    document.getElementById('format-setting').classList.remove('hidden');
                    document.getElementById('sharpen-setting').classList.remove('hidden');
                    break;
                case 'both':
                    document.getElementById('quality-setting').classList.remove('hidden');
                    document.getElementById('format-setting').classList.remove('hidden');
                    document.getElementById('sharpen-setting').classList.remove('hidden');
                    break;
            }
        }
        
        // 重置上传文件
        function resetUploadedFile() {
            document.getElementById('file-upload').value = '';
            document.getElementById('file-name').classList.add('hidden');
            document.getElementById('reset-upload').classList.add('hidden');
            document.getElementById('upload-container').classList.add('border-dashed', 'border-gray-200');
            document.getElementById('upload-container').classList.remove('border-primary');
            
            // 重置原图预览
            document.getElementById('original-image').src = '';
            document.getElementById('original-image').classList.add('hidden');
            document.getElementById('original-placeholder').classList.remove('hidden');
            document.getElementById('original-dimensions').textContent = '--';
            document.getElementById('original-size').textContent = '--';
            document.getElementById('original-format').textContent = '--';
            
            originalImageData = null;
            isImageUploaded = false;
        }
        
        // 回退到上传页
        function backToUploadStep() {
            document.getElementById('processing-settings').classList.add('hidden');
            const uploadSection = document.getElementById('upload-section');
            uploadSection.classList.remove('hidden');
            uploadSection.classList.add('force-show');
            showInfo(`已返回「${selectedFuncName}」上传页面，可重新选择图片`, 'info');
        }
        
        // 重新处理
        function reprocessImage() {
            document.getElementById('preview-section').classList.add('hidden');
            document.getElementById('processing-settings').classList.remove('hidden');
            document.getElementById('download-btn').disabled = true;
            
            // 重置处理后预览
            document.getElementById('processed-image').src = '';
            document.getElementById('processed-image').classList.add('hidden');
            document.getElementById('processed-placeholder').classList.remove('hidden');
            document.getElementById('processed-dimensions').textContent = '--';
            document.getElementById('processed-size').textContent = '--';
            document.getElementById('processed-format').textContent = '--';
            document.getElementById('optimization-info').textContent = '--';
            
            showInfo(`已返回「${selectedFuncName}」设置面板，可调整参数后重新处理`, 'info');
        }
        
        // 显示提示信息
        function showInfo(message, type = 'info') {
            const infoSection = document.getElementById('info-section');
            const infoMessage = document.getElementById('info-message');
            infoMessage.textContent = message;
            infoSection.classList.remove('hidden');
            
            // 设置样式
            infoSection.className = '';
            if (type === 'info') {
                infoSection.classList.add('bg-blue-50', 'border-l-4', 'border-primary', 'p-4', 'rounded-r-lg', 'mb-10', 'force-show');
                infoMessage.classList.add('text-blue-700');
            } else if (type === 'warning') {
                infoSection.classList.add('bg-yellow-50', 'border-l-4', 'border-yellow-400', 'p-4', 'rounded-r-lg', 'mb-10', 'force-show');
                infoMessage.classList.add('text-yellow-700');
            } else if (type === 'error') {
                infoSection.classList.add('bg-red-50', 'border-l-4', 'border-red-400', 'p-4', 'rounded-r-lg', 'mb-10', 'force-show');
                infoMessage.classList.add('text-red-700');
            }
            
            setTimeout(() => {
                infoSection.classList.add('hidden');
            }, 5000);
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
            else return (bytes / 1048576).toFixed(2) + ' MB';
        }
        
        // 计算Base64大小
        function getBase64FileSize(base64String) {
            const padding = (base64String.endsWith('==') ? 2 : base64String.endsWith('=') ? 1 : 0);
            const fileSizeInBytes = (base64String.length * 3 / 4) - padding;
            return Math.round(fileSizeInBytes);
        }
        
        // 图片清晰化
        function sharpenImage(canvas, intensity = 0.3) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const tempData = new Uint8ClampedArray(data);
            
            const kernel = [0, -1, 0, -1, 5, -1, 0, -1, 0];
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    let r = 0, g = 0, b = 0;
                    let kernelIndex = 0;
                    
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const pixelIndex = ((y + ky) * width + (x + kx)) * 4;
                            const weight = kernel[kernelIndex];
                            
                            r += tempData[pixelIndex] * weight;
                            g += tempData[pixelIndex + 1] * weight;
                            b += tempData[pixelIndex + 2] * weight;
                            
                            kernelIndex++;
                        }
                    }
                    
                    const pixelIndex = (y * width + x) * 4;
                    data[pixelIndex] = Math.min(255, Math.max(0, tempData[pixelIndex] + (r - tempData[pixelIndex]) * intensity));
                    data[pixelIndex + 1] = Math.min(255, Math.max(0, tempData[pixelIndex + 1] + (g - tempData[pixelIndex + 1]) * intensity));
                    data[pixelIndex + 2] = Math.min(255, Math.max(0, tempData[pixelIndex + 2] + (b - tempData[pixelIndex + 2]) * intensity));
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }
        
        // 处理图片
        function processImage() {
            if (!originalImageData || !selectedFunc) {
                showInfo('请先选择功能并上传图片', 'warning');
                return;
            }
            
            // 显示加载动画
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            setTimeout(() => {
                try {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = function() {
                        let canvas = document.createElement('canvas');
                        let ctx = canvas.getContext('2d');
                        let width = img.width;
                        let height = img.height;
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 获取设置
                        const quality = document.getElementById('quality').value / 100;
                        const format = document.getElementById('output-format').value;
                        const sharpenValue = document.getElementById('sharpen-intensity').value / 100;
                        const mode = selectedFunc;
                        
                        // 清晰化
                        let isSharpened = false;
                        if (mode === 'both' || mode === 'sharpen-only') {
                            if (sharpenValue > 0) {
                                canvas = sharpenImage(canvas, sharpenValue);
                                isSharpened = true;
                            }
                        }
                        
                        // 压缩
                        let base64Data;
                        let compressedSize;
                        let isCompressed = false;
                        
                        if (mode === 'both' || mode === 'compress-only') {
                            if (format === 'jpeg') {
                                base64Data = canvas.toDataURL('image/jpeg', quality);
                            } else if (format === 'webp') {
                                base64Data = canvas.toDataURL('image/webp', quality);
                            } else {
                                base64Data = canvas.toDataURL('image/png');
                            }
                            
                            compressedSize = getBase64FileSize(base64Data.split(',')[1]);
                            isCompressed = true;
                            
                            // 确保压缩后更小
                            let iterations = 0;
                            const maxIterations = 20;
                            while (compressedSize >= originalImageData.size && iterations < maxIterations) {
                                iterations++;
                                width = Math.round(width * 0.9);
                                height = Math.round(height * 0.9);
                                
                                if (width < 10 || height < 10) break;
                                
                                canvas.width = width;
                                canvas.height = height;
                                ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                if (isSharpened && sharpenValue > 0) {
                                    canvas = sharpenImage(canvas, sharpenValue);
                                }
                                
                                if (format === 'jpeg') {
                                    base64Data = canvas.toDataURL('image/jpeg', Math.max(0.1, quality - (iterations * 0.1)));
                                } else if (format === 'webp') {
                                    base64Data = canvas.toDataURL('image/webp', Math.max(0.1, quality - (iterations * 0.1)));
                                } else {
                                    base64Data = canvas.toDataURL('image/png');
                                }
                                
                                compressedSize = getBase64FileSize(base64Data.split(',')[1]);
                            }
                        } else {
                            if (format === 'jpeg') {
                                base64Data = canvas.toDataURL('image/jpeg', 1.0);
                            } else if (format === 'webp') {
                                base64Data = canvas.toDataURL('image/webp', 1.0);
                            } else {
                                base64Data = canvas.toDataURL('image/png');
                            }
                            compressedSize = getBase64FileSize(base64Data.split(',')[1]);
                        }
                        
                        // 存储处理后数据
                        processedImageData = {
                            base64: base64Data,
                            width: width,
                            height: height,
                            size: compressedSize,
                            format: format,
                            isSharpened: isSharpened,
                            isCompressed: isCompressed
                        };
                        
                        // 更新预览
                        const processedImage = document.getElementById('processed-image');
                        const processedPlaceholder = document.getElementById('processed-placeholder');
                        processedImage.src = base64Data;
                        processedImage.classList.remove('hidden');
                        processedPlaceholder.classList.add('hidden');
                        document.getElementById('processed-dimensions').textContent = `${width} × ${height} 像素`;
                        document.getElementById('processed-size').textContent = formatFileSize(compressedSize);
                        document.getElementById('processed-format').textContent = format.toUpperCase();
                        
                        // 优化信息
                        let optimizationText = '';
                        if (isSharpened && isCompressed) {
                            optimizationText = '清晰化+压缩';
                        } else if (isSharpened) {
                            optimizationText = '仅清晰化';
                        } else if (isCompressed) {
                            optimizationText = '仅压缩';
                        }
                        document.getElementById('optimization-info').textContent = optimizationText;
                        
                        // 显示结果
                        document.getElementById('processing-settings').classList.add('hidden');
                        document.getElementById('preview-section').classList.remove('hidden');
                        document.getElementById('download-btn').disabled = false;
                        
                        // 提示信息
                        const rate = isCompressed ? ((1 - compressedSize / originalImageData.size) * 100).toFixed(1) : '无';
                        showInfo(`图片处理成功！优化方式：${optimizationText}${isCompressed ? '，压缩率：' + rate + '%' : ''}`, 'info');
                        
                        // 隐藏加载动画
                        document.getElementById('loading-overlay').classList.add('hidden');
                    };
                    img.src = originalImageData.base64;
                } catch (error) {
                    showInfo(`处理失败: ${error.message}`, 'error');
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            }, 100);
        }
        
        // 下载图片
        document.getElementById('download-btn').addEventListener('click', function() {
            if (!processedImageData) return;
            
            const link = document.createElement('a');
            link.href = processedImageData.base64;
            const originalName = document.getElementById('file-name').textContent.split('.').slice(0, -1).join('.');
            const processSuffix = selectedFuncName.replace(/、|（|）/g, '_').toLowerCase();
            link.download = `${originalName}_${processSuffix}.${processedImageData.format}`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showInfo('处理后图片已下载', 'info');
        });
    </script>

</body>
</html>
