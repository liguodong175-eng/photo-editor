<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>狗蛋图片压缩</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 新增：蓝猫头像 favicon -->
  <link rel="icon" type="image/svg+xml" href="blue-cat-icon.svg" />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 24px 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      padding: 24px 28px 28px;
    }

    h1 {
      font-size: 24px;
      margin: 0 0 16px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #111827;
    }

    .section {
      margin-top: 16px;
      margin-bottom: 10px;
      padding: 12px 14px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .file-input-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    input[type="file"] {
      font-size: 13px;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 8px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .control-label {
      font-weight: 500;
      color: #374151;
    }

    .control-label span.value {
      font-weight: 600;
      color: #2563eb;
      margin-left: 4px;
    }

    input[type="range"] {
      width: 100%;
    }

    select,
    input[type="number"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      outline: none;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin-top: 4px;
    }

    .checkbox-row input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }

    .button-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease, opacity 0.08s ease;
      text-decoration: none;
      user-select: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:disabled {
      background: #9ca3af;
      box-shadow: none;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.15);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.18);
    }

    .btn-xs {
      padding: 4px 10px;
      font-size: 11px;
    }

    .preview-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px 12px;
      background: #ffffff;
    }

    .preview-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #111827;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5f0ff;
      color: #1d4ed8;
      font-weight: 500;
    }

    .preview-info {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
      min-height: 35px;
    }

    .preview-image-wrap {
      border-radius: 10px;
      overflow: hidden;
      background: repeating-conic-gradient(#e5e7eb 0 25%, #f9fafb 0 50%) 50% / 16px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      max-height: 260px;
    }

    .preview-image-wrap img {
      max-width: 100%;
      max-height: 260px;
      display: none;
    }

    .note {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
    }

    .size-mode-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .size-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    .size-row input[type="number"] {
      width: 90px;
    }

    .image-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 10px;
    }

    .image-row {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px 12px;
      background: #f9fafb;
    }

    .image-row-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .image-row-title {
      font-weight: 600;
      font-size: 13px;
      color: #111827;
    }

    .image-row-meta {
      font-size: 12px;
      color: #6b7280;
    }

    .image-row-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .image-row-actions {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
    }

    @media (max-width: 640px) {
      .card {
        padding: 18px 16px 20px;
      }

      .button-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>狗蛋图片压缩</h1>
      <div class="subtitle">
        所有处理均在浏览器本地完成，不上传服务器。支持多张图片批量压缩、格式转换、清晰度增强。
      </div>

      <!-- 1. 批量上传 -->
      <div class="section">
        <div class="section-title">1. 选择图片（可多选）</div>
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" accept="image/*" multiple />
          <div class="hint">按住 Ctrl / ⌘ 或 Shift 可一次选择多张图片。</div>
        </div>
      </div>

      <!-- 2. 参数设置 -->
      <div class="section">
        <div class="section-title">2. 设置压缩参数（所有图片统一使用当前参数）</div>
        <div class="controls-grid">
          <!-- 尺寸模式：比例 / 手动 -->
          <div class="control-group">
            <div class="control-label">输出尺寸：</div>
            <div class="size-mode-row">
              <label class="radio-label">
                <input type="radio" name="sizeMode" value="scale" checked />
                按比例缩放
              </label>
              <label class="radio-label">
                <input type="radio" name="sizeMode" value="manual" />
                手动输入尺寸（px）
              </label>
            </div>

            <!-- 按比例 -->
            <div class="size-mode" id="scaleModeBlock">
              <div class="size-row">
                <span class="hint">
                  缩放比例：
                  <span class="value" id="scaleValueText">100%</span>
                </span>
              </div>
              <input type="range" id="scaleRange" min="10" max="100" value="100" />
              <div class="hint">
                示例输出尺寸（以首张图片为例）：<span id="targetSizeText">-</span>
              </div>
            </div>

            <!-- 手动输入 -->
            <div class="size-mode" id="manualModeBlock" style="display: none;">
              <div class="size-row">
                <label class="hint">
                  宽度(px)：
                  <input type="number" id="manualWidthInput" min="1" step="1" />
                </label>
                <label class="hint">
                  高度(px)：
                  <input type="number" id="manualHeightInput" min="1" step="1" />
                </label>
              </div>
              <div class="hint">
                将所有图片统一输出为指定尺寸，可能会产生轻微形变，如需严格等比可使用“按比例缩放”模式。
              </div>
            </div>
          </div>

          <!-- 质量 -->
          <div class="control-group">
            <div class="control-label">
              压缩质量（仅 JPEG / WebP 有效）：
              <span class="value" id="qualityValueText">80%</span>
            </div>
            <input type="range" id="qualityRange" min="10" max="100" value="80" />
            <div class="hint">
              数值越小，体积越小但画质越差；建议 60% ~ 90%。
            </div>
          </div>

          <!-- 格式 -->
          <div class="control-group">
            <div class="control-label">输出格式：</div>
            <select id="formatSelect">
              <option value="original">保持原格式（每张各自保持）</option>
              <option value="image/jpeg">统一转为 JPEG（有损压缩，体积较小）</option>
              <option value="image/png">统一转为 PNG（无损压缩，适合透明图）</option>
              <option value="image/webp">统一转为 WebP（高压缩率，现代浏览器）</option>
            </select>
            <div class="hint">
              注意：将带透明通道的 PNG 转成 JPEG 时会自动填充白色背景。
            </div>
          </div>

          <!-- 锐化 -->
          <div class="control-group">
            <div class="control-label">
              清晰度修复（锐化）强度：
              <span class="value" id="sharpenValueText">0%</span>
            </div>
            <input type="range" id="sharpenRange" min="0" max="100" value="0" disabled />
            <div class="checkbox-row">
              <input type="checkbox" id="sharpenToggle" />
              <label for="sharpenToggle">开启清晰度修复（针对略微模糊的图片）</label>
            </div>
          </div>
        </div>

        <div class="button-row">
          <button class="btn btn-primary" id="compressAllBtn" disabled>开始压缩全部</button>
          <button class="btn btn-secondary" id="resetBtn" type="button">重置</button>
          <button class="btn btn-primary" id="downloadAllBtn" type="button" disabled>
            批量下载压缩图片
          </button>
        </div>
        <div class="hint" style="margin-top: 6px;">
          提示：批量下载会依次触发多次浏览器下载操作，部分浏览器可能会弹出“允许多文件下载”的确认。
        </div>
      </div>

      <!-- 3. 预览与对比 -->
      <div class="section">
        <div class="section-title">3. 预览与对比（支持多张图片）</div>
        <div id="imageList" class="image-list">
          <div class="hint">请先在上方选择一张或多张图片。</div>
        </div>
        <div class="note">
          温馨提示：如果单张图片非常大（例如超过 8000×8000 像素），在浏览器中处理可能会稍慢或内存吃紧，可先用系统工具粗略缩小后再上传精细压缩。
        </div>
      </div>
    </div>
  </div>

  <script>
    // 全局状态：多张图片
    let imageRecords = [];
    let sizeMode = "scale"; // "scale" | "manual"

    // DOM 元素
    const fileInput = document.getElementById("fileInput");
    const scaleRange = document.getElementById("scaleRange");
    const scaleValueText = document.getElementById("scaleValueText");
    const targetSizeText = document.getElementById("targetSizeText");
    const manualWidthInput = document.getElementById("manualWidthInput");
    const manualHeightInput = document.getElementById("manualHeightInput");
    const qualityRange = document.getElementById("qualityRange");
    const qualityValueText = document.getElementById("qualityValueText");
    const formatSelect = document.getElementById("formatSelect");
    const sharpenRange = document.getElementById("sharpenRange");
    const sharpenValueText = document.getElementById("sharpenValueText");
    const sharpenToggle = document.getElementById("sharpenToggle");
    const compressAllBtn = document.getElementById("compressAllBtn");
    const resetBtn = document.getElementById("resetBtn");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const imageList = document.getElementById("imageList");

    const sizeModeRadios = document.querySelectorAll('input[name="sizeMode"]');
    const scaleModeBlock = document.getElementById("scaleModeBlock");
    const manualModeBlock = document.getElementById("manualModeBlock");

    compressAllBtn.disabled = true;
    downloadAllBtn.disabled = true;

    function formatFileSize(bytes) {
      if (!Number.isFinite(bytes)) return "-";
      if (bytes >= 1024 * 1024) {
        return (bytes / (1024 * 1024)).toFixed(2) + " MB";
      }
      return (bytes / 1024).toFixed(2) + " KB";
    }

    function dataURLToBlob(dataURL) {
      const parts = dataURL.split(",");
      const match = parts[0].match(/:(.*?);/);
      const mime = match ? match[1] : "image/png";
      const bstr = atob(parts[1]);
      const len = bstr.length;
      const u8arr = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        u8arr[i] = bstr.charCodeAt(i);
      }
      return new Blob([u8arr], { type: mime });
    }

    function getTargetMime(selected, originalMime) {
      if (selected === "original") {
        if (["image/jpeg", "image/png", "image/webp"].includes(originalMime)) {
          return originalMime;
        }
        return "image/png";
      }
      return selected;
    }

    function getExtensionByMime(mime) {
      switch (mime) {
        case "image/jpeg":
          return ".jpg";
        case "image/png":
          return ".png";
        case "image/webp":
          return ".webp";
        default:
          return ".png";
      }
    }

    function applySharpen(imageData, amount) {
      if (amount <= 0) return imageData;

      const w = imageData.width;
      const h = imageData.height;
      const src = imageData.data;
      const dst = new Uint8ClampedArray(src.length);

      const kernel = [
        0, -1, 0,
        -1, 5, -1,
        0, -1, 0
      ];

      function clamp(v) {
        v = Math.round(v);
        if (v < 0) return 0;
        if (v > 255) return 255;
        return v;
      }

      for (let y = 1; y < h - 1; y++) {
        for (let x = 1; x < w - 1; x++) {
          let r = 0, g = 0, b = 0;
          let kIndex = 0;

          for (let ky = -1; ky <= 1; ky++) {
            for (let kx = -1; kx <= 1; kx++) {
              const px = x + kx;
              const py = y + ky;
              const idx = (py * w + px) * 4;
              const k = kernel[kIndex++];

              r += src[idx] * k;
              g += src[idx + 1] * k;
              b += src[idx + 2] * k;
            }
          }

          const idx = (y * w + x) * 4;
          const or = src[idx];
          const og = src[idx + 1];
          const ob = src[idx + 2];

          dst[idx] = clamp(or * (1 - amount) + r * amount);
          dst[idx + 1] = clamp(og * (1 - amount) + g * amount);
          dst[idx + 2] = clamp(ob * (1 - amount) + b * amount);
          dst[idx + 3] = src[idx + 3];
        }
      }

      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          if (x === 0 || x === w - 1 || y === 0 || y === h - 1) {
            const idx = (y * w + x) * 4;
            dst[idx] = src[idx];
            dst[idx + 1] = src[idx + 1];
            dst[idx + 2] = src[idx + 2];
            dst[idx + 3] = src[idx + 3];
          }
        }
      }

      imageData.data.set(dst);
      return imageData;
    }

    function getFirstLoadedImageRecord() {
      return imageRecords.find((rec) => rec.img);
    }

    function updateFirstTargetSizeLabel() {
      const rec = getFirstLoadedImageRecord();
      if (!rec) {
        targetSizeText.textContent = "-";
        return;
      }

      if (sizeMode === "scale") {
        const scale = parseInt(scaleRange.value, 10) || 100;
        const w = Math.max(1, Math.round((rec.originalWidth * scale) / 100));
        const h = Math.max(1, Math.round((rec.originalHeight * scale) / 100));
        targetSizeText.textContent = w + " × " + h + " px";
      } else {
        const mw = parseInt(manualWidthInput.value, 10);
        const mh = parseInt(manualHeightInput.value, 10);
        if (mw > 0 && mh > 0) {
          targetSizeText.textContent = mw + " × " + mh + " px";
        } else {
          targetSizeText.textContent = "-";
        }
      }
    }

    function clearAllImages() {
      imageRecords.forEach((rec) => {
        if (rec.originalUrl) {
          URL.revokeObjectURL(rec.originalUrl);
        }
        if (rec.compressedUrl) {
          URL.revokeObjectURL(rec.compressedUrl);
        }
      });
      imageRecords = [];
      imageList.innerHTML = '<div class="hint">请先在上方选择一张或多张图片。</div>';
      compressAllBtn.disabled = true;
      downloadAllBtn.disabled = true;
      targetSizeText.textContent = "-";
    }

    function createImageItem(file, index) {
      const row = document.createElement("div");
      row.className = "image-row";

      row.innerHTML = `
        <div class="image-row-header">
          <div class="image-row-title">${file.name}</div>
          <div class="image-row-meta">原始大小：${formatFileSize(file.size)}</div>
        </div>
        <div class="image-row-grid">
          <div class="preview-card">
            <div class="preview-title">
              原始图片
              <span class="badge">源文件</span>
            </div>
            <div class="preview-info js-original-info">加载中…</div>
            <div class="preview-image-wrap">
              <img class="js-original-img" alt="原始预览">
            </div>
          </div>
          <div class="preview-card">
            <div class="preview-title">
              压缩后图片
              <span class="badge js-compressed-badge">待生成</span>
            </div>
            <div class="preview-info js-compressed-info">压缩后信息将显示在这里</div>
            <div class="preview-image-wrap">
              <img class="js-compressed-img" alt="压缩预览">
            </div>
            <div class="image-row-actions">
              <button type="button" class="btn btn-secondary btn-xs js-download-single" disabled>下载此图</button>
            </div>
          </div>
        </div>
      `;

      const originalInfoEl = row.querySelector(".js-original-info");
      const originalImgEl = row.querySelector(".js-original-img");
      const compressedInfoEl = row.querySelector(".js-compressed-info");
      const compressedImgEl = row.querySelector(".js-compressed-img");
      const compressedBadgeEl = row.querySelector(".js-compressed-badge");
      const downloadBtnEl = row.querySelector(".js-download-single");

      const originalUrl = URL.createObjectURL(file);
      const img = new Image();

      const record = {
        id: index,
        file,
        img: null,
        originalUrl,
        originalWidth: 0,
        originalHeight: 0,
        compressedBlob: null,
        compressedUrl: null,
        elements: {
          originalInfoEl,
          originalImgEl,
          compressedInfoEl,
          compressedImgEl,
          compressedBadgeEl,
          downloadBtnEl
        }
      };

      img.onload = function () {
        record.img = img;
        record.originalWidth = img.width;
        record.originalHeight = img.height;

        originalImgEl.src = originalUrl;
        originalImgEl.style.display = "block";

        originalInfoEl.innerHTML =
          "格式：" +
          (file.type || "未知") +
          "<br>尺寸：" +
          img.width +
          " × " +
          img.height +
          " px" +
          "<br>大小：" +
          formatFileSize(file.size);

        updateFirstTargetSizeLabel();
      };

      img.onerror = function () {
        originalInfoEl.textContent = "图片加载失败";
      };

      img.src = originalUrl;

      downloadBtnEl.addEventListener("click", function () {
        if (!record.compressedUrl || !record.compressedBlob) return;
        const a = document.createElement("a");
        a.href = record.compressedUrl;
        const ext = getExtensionByMime(record.compressedBlob.type || getTargetMime(formatSelect.value, file.type || "image/png"));
        const nameWithoutExt = (file.name || "image").replace(/\.[^/.]+$/, "");
        a.download = nameWithoutExt + "-compressed" + ext;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });

      imageList.appendChild(row);
      return record;
    }

    function compressRecord(record, options) {
      if (!record.img) return;

      const { sizeMode, scale, manualWidth, manualHeight, selectedFormat, quality, sharpenAmount } = options;
      const originalMime = record.file.type || "image/png";
      const mime = getTargetMime(selectedFormat, originalMime);

      let targetW;
      let targetH;

      if (sizeMode === "scale") {
        targetW = Math.max(1, Math.round(record.originalWidth * scale));
        targetH = Math.max(1, Math.round(record.originalHeight * scale));
      } else {
        targetW = manualWidth > 0 ? manualWidth : record.originalWidth;
        targetH = manualHeight > 0 ? manualHeight : record.originalHeight;
      }

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = targetW;
      canvas.height = targetH;

      if (mime === "image/jpeg") {
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      ctx.drawImage(record.img, 0, 0, canvas.width, canvas.height);

      if (sharpenAmount > 0) {
        try {
          let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          imgData = applySharpen(imgData, sharpenAmount);
          ctx.putImageData(imgData, 0, 0);
        } catch (e) {
          console.warn("锐化处理失败（可能是图片过大）：", e);
        }
      }

      let dataURL;
      if (mime === "image/png") {
        dataURL = canvas.toDataURL("image/png");
      } else {
        dataURL = canvas.toDataURL(mime, quality);
      }

      const blob = dataURLToBlob(dataURL);

      if (record.compressedUrl) {
        URL.revokeObjectURL(record.compressedUrl);
      }

      record.compressedBlob = blob;
      record.compressedUrl = URL.createObjectURL(blob);

      const els = record.elements;
      els.compressedImgEl.src = record.compressedUrl;
      els.compressedImgEl.style.display = "block";

      const sizeText = formatFileSize(blob.size);
      let ratioText = "";
      if (record.file.size > 0) {
        const ratio = ((blob.size / record.file.size) * 100).toFixed(1);
        ratioText = "（约为原始大小的 " + ratio + "%）";
      }

      els.compressedInfoEl.innerHTML =
        "尺寸：" +
        targetW +
        " × " +
        targetH +
        " px" +
        "<br>大小：" +
        sizeText +
        " " +
        ratioText;
      els.compressedBadgeEl.textContent = "已生成";
      els.downloadBtnEl.disabled = false;
    }

    fileInput.addEventListener("change", function () {
      clearAllImages();
      const files = Array.from(fileInput.files || []);
      const imageFiles = files.filter((f) => f.type && f.type.startsWith("image/"));

      if (imageFiles.length === 0) {
        if (files.length > 0) {
          alert("请选择图片文件（JPG / PNG / WebP 等）");
        }
        return;
      }

      imageList.innerHTML = "";
      imageFiles.forEach((file, idx) => {
        const rec = createImageItem(file, idx);
        imageRecords.push(rec);
      });

      compressAllBtn.disabled = false;
    });

    sizeModeRadios.forEach((radio) => {
      radio.addEventListener("change", function () {
        if (this.checked) {
          sizeMode = this.value;
          if (sizeMode === "scale") {
            scaleModeBlock.style.display = "block";
            manualModeBlock.style.display = "none";
          } else {
            scaleModeBlock.style.display = "none";
            manualModeBlock.style.display = "block";
          }
          updateFirstTargetSizeLabel();
        }
      });
    });

    scaleRange.addEventListener("input", function () {
      const value = parseInt(scaleRange.value, 10) || 100;
      scaleValueText.textContent = value + "%";
      if (sizeMode === "scale") {
        updateFirstTargetSizeLabel();
      }
    });

    manualWidthInput.addEventListener("input", function () {
      if (sizeMode === "manual") {
        updateFirstTargetSizeLabel();
      }
    });
    manualHeightInput.addEventListener("input", function () {
      if (sizeMode === "manual") {
        updateFirstTargetSizeLabel();
      }
    });

    qualityRange.addEventListener("input", function () {
      const value = parseInt(qualityRange.value, 10) || 80;
      qualityValueText.textContent = value + "%";
    });

    sharpenToggle.addEventListener("change", function () {
      const enabled = sharpenToggle.checked;
      sharpenRange.disabled = !enabled;
      if (!enabled) {
        sharpenRange.value = 0;
        sharpenValueText.textContent = "0%";
      }
    });

    sharpenRange.addEventListener("input", function () {
      const value = parseInt(sharpenRange.value, 10) || 0;
      sharpenValueText.textContent = value + "%";
    });

    compressAllBtn.addEventListener("click", function () {
      if (imageRecords.length === 0) {
        alert("请先选择图片。");
        return;
      }

      const selectedFormat = formatSelect.value;
      const quality = (parseInt(qualityRange.value, 10) || 80) / 100;
      const sharpenEnabled = sharpenToggle.checked;
      const sharpenAmount = sharpenEnabled ? (parseInt(sharpenRange.value, 10) || 0) / 100 : 0;
      const scale = (parseInt(scaleRange.value, 10) || 100) / 100;
      const manualWidth = parseInt(manualWidthInput.value, 10) || 0;
      const manualHeight = parseInt(manualHeightInput.value, 10) || 0;

      const options = {
        sizeMode,
        scale,
        manualWidth,
        manualHeight,
        selectedFormat,
        quality,
        sharpenAmount
      };

      imageRecords.forEach((rec) => {
        if (rec.img) {
          compressRecord(rec, options);
        }
      });

      const hasCompressed = imageRecords.some((rec) => rec.compressedUrl);
      downloadAllBtn.disabled = !hasCompressed;
    });

    downloadAllBtn.addEventListener("click", function () {
      const compressedRecords = imageRecords.filter((rec) => rec.compressedUrl && rec.compressedBlob);
      if (compressedRecords.length === 0) {
        alert("请先完成压缩。");
        return;
      }

      compressedRecords.forEach((rec, idx) => {
        const a = document.createElement("a");
        a.href = rec.compressedUrl;
        const ext = getExtensionByMime(rec.compressedBlob.type || getTargetMime(formatSelect.value, rec.file.type || "image/png"));
        const nameWithoutExt = (rec.file.name || "image-" + (idx + 1)).replace(/\.[^/.]+$/, "");
        a.download = nameWithoutExt + "-compressed" + ext;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    });

    resetBtn.addEventListener("click", function () {
      fileInput.value = "";
      clearAllImages();

      sizeMode = "scale";
      sizeModeRadios.forEach((r) => {
        r.checked = r.value === "scale";
      });
      scaleModeBlock.style.display = "block";
      manualModeBlock.style.display = "none";

      scaleRange.value = 100;
      scaleValueText.textContent = "100%";
      manualWidthInput.value = "";
      manualHeightInput.value = "";
      targetSizeText.textContent = "-";

      qualityRange.value = 80;
      qualityValueText.textContent = "80%";

      sharpenToggle.checked = false;
      sharpenRange.disabled = true;
      sharpenRange.value = 0;
      sharpenValueText.textContent = "0%";

      formatSelect.value = "original";
    });
  </script>
</body>
</html>
