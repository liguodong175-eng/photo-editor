<script>
    // ====== 全局状态 ======
    let currentPath = '/';
    const routePages = document.querySelectorAll('.route-page');
    const navItems = document.querySelectorAll('.nav-item');

    const uploadedFiles = {
        pdf: [],
        video: [],
        image: []
    };

    const compressedFiles = {
        pdf: null,    // { format, files: File[] }
        video: null,  // { format, files: File[] }
        image: null   // { format, files: File[] }
    };

    // ====== 辅助方法 ======
    function humanFileSize(size) {
        if (size === 0) return '0 B';
        const units = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(size) / Math.log(1024));
        const value = size / Math.pow(1024, i);
        return value.toFixed(2) + ' ' + units[i];
    }

    function showLoadingOverlay(show) {
        const overlay = document.getElementById('loading-overlay');
        if (!overlay) return;
        if (show) {
            overlay.classList.remove('hidden');
        } else {
            overlay.classList.add('hidden');
        }
    }

    function navigateTo(path) {
        if (window.location.hash !== '#' + path) {
            window.location.hash = '#' + path;
        } else {
            // hash 未变更时手动触发一次
            handleHashChange();
        }
    }

    function updateNav() {
        navItems.forEach(item => {
            const path = item.getAttribute('data-path');
            if (path === currentPath) {
                item.classList.add('nav-active');
            } else {
                item.classList.remove('nav-active');
            }
        });
    }

    // ====== 路由：hash 变化处理 ======
    function handleHashChange() {
        const hash = window.location.hash || '#/';
        currentPath = hash.slice(1); // 去掉 #

        // 1. 隐藏所有页面
        routePages.forEach(page => page.classList.add('hidden'));

        // 2. 根据路径显示对应页面
        let targetPageId = 'home-page';
        switch (currentPath) {
            case '/':
                targetPageId = 'home-page';
                break;
            case '/pdf-compress':
                targetPageId = 'pdf-compress-page';
                break;
            case '/video-compress':
                targetPageId = 'video-compress-page';
                break;
            case '/image-compress':
                targetPageId = 'image-compress-page';
                break;
            default:
                targetPageId = 'home-page';
                currentPath = '/';
        }

        const targetPage = document.getElementById(targetPageId);
        if (targetPage) {
            targetPage.classList.remove('hidden');
        }

        // 3. 更新导航高亮
        updateNav();

        // 4. 关闭移动端菜单
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
            mobileMenu.classList.add('hidden');
        }
    }

    function handleNavClick(event, path) {
        event.preventDefault();
        navigateTo(path);
    }

    // ====== 文件列表渲染 ======
    function renderFileList(type) {
        let listWrapper, listContainer;
        if (type === 'pdf') {
            listWrapper = document.getElementById('pdf-file-list');
            listContainer = document.getElementById('pdf-files-container');
        } else if (type === 'video') {
            listWrapper = document.getElementById('video-file-list');
            listContainer = document.getElementById('video-files-container');
        } else if (type === 'image') {
            listWrapper = document.getElementById('image-file-list');
            listContainer = document.getElementById('image-files-container');
        }

        if (!listWrapper || !listContainer) return;

        const files = uploadedFiles[type] || [];
        if (!files.length) {
            listWrapper.classList.add('hidden');
            listContainer.innerHTML = '';
            return;
        }

        listWrapper.classList.remove('hidden');
        listContainer.innerHTML = '';

        files.forEach(file => {
            const div = document.createElement('div');
            div.className = 'px-3 py-1 rounded-full bg-gray-100 text-xs flex items-center space-x-2';
            div.innerHTML = `
                <span class="truncate max-w-[140px]">${file.name}</span>
                <span class="text-neutral text-[11px]">${humanFileSize(file.size)}</span>
            `;
            listContainer.appendChild(div);
        });
    }

    function replaceFileExt(name, newExt) {
        const idx = name.lastIndexOf('.');
        if (idx === -1) return name + '.' + newExt;
        return name.slice(0, idx + 1) + newExt;
    }

    // 简单锐化滤镜（可选）
    function applySharpen(ctx, width, height) {
        const imgData = ctx.getImageData(0, 0, width, height);
        const data = imgData.data;
        const copy = new Uint8ClampedArray(data);
        const w = width;
        const h = height;
        const kernel = [
            0, -1, 0,
            -1, 5, -1,
            0, -1, 0
        ];
        const side = 3;
        const half = 1;

        for (let y = 1; y < h - 1; y++) {
            for (let x = 1; x < w - 1; x++) {
                let r = 0, g = 0, b = 0;
                for (let ky = -half; ky <= half; ky++) {
                    for (let kx = -half; kx <= half; kx++) {
                        const cx = x + kx;
                        const cy = y + ky;
                        const pos = (cy * w + cx) * 4;
                        const weight = kernel[(ky + half) * side + (kx + half)];
                        r += copy[pos] * weight;
                        g += copy[pos + 1] * weight;
                        b += copy[pos + 2] * weight;
                    }
                }
                const i = (y * w + x) * 4;
                data[i] = Math.min(255, Math.max(0, r));
                data[i + 1] = Math.min(255, Math.max(0, g));
                data[i + 2] = Math.min(255, Math.max(0, b));
            }
        }
        ctx.putImageData(imgData, 0, 0);
    }

    function compressSingleImage(file, format, quality, needSharpen) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = function () {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                let w = img.naturalWidth;
                let h = img.naturalHeight;
                // 防止超大图片，可设置一个最大边长
                const maxSide = 2000;
                if (w > maxSide || h > maxSide) {
                    const scale = Math.min(maxSide / w, maxSide / h);
                    w = Math.round(w * scale);
                    h = Math.round(h * scale);
                }

                canvas.width = w;
                canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);

                if (needSharpen) {
                    applySharpen(ctx, w, h);
                }

                let mimeType;
                if (format === 'png') mimeType = 'image/png';
                else if (format === 'webp') mimeType = 'image/webp';
                else mimeType = 'image/jpeg';

                const qualityParam = (format === 'png') ? 1 : quality; // PNG 质量参数基本无效

                canvas.toBlob(blob => {
                    if (!blob) {
                        reject(new Error('图片压缩失败'));
                        return;
                    }
                    const newName = replaceFileExt(file.name, format === 'jpg' ? 'jpg' : format);
                    const newFile = new File([blob], newName, { type: mimeType });
                    resolve(newFile);
                }, mimeType, qualityParam);
            };
            img.onerror = () => reject(new Error('图片加载失败'));
            img.src = URL.createObjectURL(file);
        });
    }

    // ====== 图片压缩主流程 ======
    async function compressImageFiles() {
        const files = uploadedFiles.image;
        if (!files.length) return;

        const qualityInput = document.getElementById('image-quality');
        const formatSelect = document.getElementById('image-output-format');
        const sharpenSelect = document.getElementById('image-sharpen');

        const quality = (qualityInput ? Number(qualityInput.value) : 80) / 100;
        const format = formatSelect ? formatSelect.value : 'jpg';
        const needSharpen = sharpenSelect ? (sharpenSelect.value === 'yes') : false;

        const progressWrapper = document.getElementById('image-progress');
        const progressBar = document.getElementById('image-progress-bar');
        const progressText = document.getElementById('image-progress-text');

        const resultWrapper = document.getElementById('image-result');
        const originalSizeSpan = document.getElementById('image-original-size');
        const compressedSizeSpan = document.getElementById('image-compressed-size');

        progressWrapper.classList.remove('hidden');
        resultWrapper.classList.add('hidden');
        showLoadingOverlay(true);

        let totalOriginal = 0;
        let totalCompressed = 0;
        const outputFiles = [];

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            totalOriginal += file.size;

            const newFile = await compressSingleImage(file, format, quality, needSharpen);
            outputFiles.push(newFile);
            totalCompressed += newFile.size;

            const percent = Math.round(((i + 1) / files.length) * 100);
            if (progressBar) progressBar.style.width = percent + '%';
            if (progressText) progressText.textContent = percent + '%';
        }

        compressedFiles.image = { format, files: outputFiles };

        if (originalSizeSpan) originalSizeSpan.textContent = humanFileSize(totalOriginal);
        if (compressedSizeSpan) compressedSizeSpan.textContent = humanFileSize(totalCompressed);

        progressWrapper.classList.add('hidden');
        resultWrapper.classList.remove('hidden');
        showLoadingOverlay(false);
    }

    // ====== PDF / 视频：先打通流程，压缩算法留 TODO ======
    function simulateProcess(type) {
        const files = uploadedFiles[type];
        if (!files.length) return;

        const progressWrapper = document.getElementById(type + '-progress');
        const progressBar = document.getElementById(type + '-progress-bar');
        const progressText = document.getElementById(type + '-progress-text');
        const resultWrapper = document.getElementById(type + '-result');
        const originalSizeSpan = document.getElementById(type + '-original-size');
        const compressedSizeSpan = document.getElementById(type + '-compressed-size');

        let totalSize = files.reduce((sum, f) => sum + f.size, 0);
        if (originalSizeSpan) originalSizeSpan.textContent = humanFileSize(totalSize);

        // 这里暂时模拟“压缩后 60% 大小”
        const fakeCompressedSize = Math.round(totalSize * 0.6);
        if (compressedSizeSpan) compressedSizeSpan.textContent = humanFileSize(fakeCompressedSize);

        progressWrapper.classList.remove('hidden');
        resultWrapper.classList.add('hidden');
        showLoadingOverlay(true);

        let percent = 0;
        const timer = setInterval(() => {
            percent += 10;
            if (percent > 100) percent = 100;
            if (progressBar) progressBar.style.width = percent + '%';
            if (progressText) progressText.textContent = percent + '%';

            if (percent === 100) {
                clearInterval(timer);
                progressWrapper.classList.add('hidden');
                resultWrapper.classList.remove('hidden');
                showLoadingOverlay(false);

                // TODO：这里目前把“原文件”塞回去，后续你接入真实压缩后，把生成的新 File 替换这里
                let format = null;
                if (type === 'pdf') {
                    const sel = document.getElementById('pdf-output-format');
                    format = sel ? sel.value : 'pdf';
                } else if (type === 'video') {
                    const sel = document.getElementById('video-output-format');
                    format = sel ? sel.value : 'mp4';
                }
                compressedFiles[type] = { format, files: files.slice() };
            }
        }, 200);
    }

    // ====== 绑定上传事件 ======
    function bindUploadEvents() {
        // PDF
        const pdfInput = document.getElementById('pdf-upload');
        if (pdfInput) {
            pdfInput.addEventListener('change', (e) => {
                uploadedFiles.pdf = Array.from(e.target.files || []);
                renderFileList('pdf');
                const btn = document.getElementById('pdf-process-btn');
                if (btn) btn.disabled = uploadedFiles.pdf.length === 0;
            });
        }

        // 视频
        const videoInput = document.getElementById('video-upload');
        if (videoInput) {
            videoInput.addEventListener('change', (e) => {
                uploadedFiles.video = Array.from(e.target.files || []);
                renderFileList('video');
                const btn = document.getElementById('video-process-btn');
                if (btn) btn.disabled = uploadedFiles.video.length === 0;
            });
        }

        // 图片
        const imageInput = document.getElementById('image-upload');
        if (imageInput) {
            imageInput.addEventListener('change', (e) => {
                uploadedFiles.image = Array.from(e.target.files || []);
                renderFileList('image');
                const btn = document.getElementById('image-process-btn');
                if (btn) btn.disabled = uploadedFiles.image.length === 0;
            });
        }
    }

    // ====== 绑定按钮事件 ======
    function bindButtonEvents() {
        // 首页三个卡片上的“立即压缩”
        // 已经在 HTML 上写了 onclick="navigateTo('/xxx')"，这里就不重复绑定了

        // PDF 开始压缩
        const pdfBtn = document.getElementById('pdf-process-btn');
        if (pdfBtn) {
            pdfBtn.addEventListener('click', () => {
                // TODO: 替换为真实 PDF 压缩逻辑
                simulateProcess('pdf');
            });
        }

        // PDF 下载
        const pdfDownloadBtn = document.getElementById('pdf-download-btn');
        if (pdfDownloadBtn) {
            pdfDownloadBtn.addEventListener('click', () => {
                const data = compressedFiles.pdf;
                if (!data || !data.files || !data.files.length) return;
                data.files.forEach(file => {
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                });
            });
        }

        // 视频 开始压缩
        const videoBtn = document.getElementById('video-process-btn');
        if (videoBtn) {
            videoBtn.addEventListener('click', () => {
                // TODO: 替换为真实视频压缩（例如 ffmpeg.wasm）
                simulateProcess('video');
            });
        }

        // 视频 下载
        const videoDownloadBtn = document.getElementById('video-download-btn');
        if (videoDownloadBtn) {
            videoDownloadBtn.addEventListener('click', () => {
                const data = compressedFiles.video;
                if (!data || !data.files || !data.files.length) return;
                data.files.forEach(file => {
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                });
            });
        }

        // 图片 开始压缩
        const imageBtn = document.getElementById('image-process-btn');
        if (imageBtn) {
            imageBtn.addEventListener('click', () => {
                compressImageFiles();
            });
        }

        // 图片 下载
        const imageDownloadBtn = document.getElementById('image-download-btn');
        if (imageDownloadBtn) {
            imageDownloadBtn.addEventListener('click', () => {
                const data = compressedFiles.image;
                if (!data || !data.files || !data.files.length) return;
                data.files.forEach(file => {
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                });
            });
        }

        // 图片质量滑块
        const imageQualitySlider = document.getElementById('image-quality');
        const imageQualityValue = document.getElementById('image-quality-value');
        if (imageQualitySlider && imageQualityValue) {
            imageQualitySlider.addEventListener('input', function () {
                imageQualityValue.textContent = this.value;
            });
        }

        // 移动端菜单按钮
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                const mobileMenu = document.getElementById('mobile-menu');
                if (mobileMenu) {
                    mobileMenu.classList.toggle('hidden');
                }
            });
        }
    }

    // ====== 初始化 ======
    function initRouter() {
        window.addEventListener('hashchange', handleHashChange);
        handleHashChange(); // 首次加载
        bindUploadEvents();
        bindButtonEvents();
    }

    window.addEventListener('DOMContentLoaded', initRouter);
</script>
